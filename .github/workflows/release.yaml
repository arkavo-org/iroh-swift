name: Release

on:
  push:
    branches: [main]
    paths:
      - 'VERSION'

env:
  MACOSX_DEPLOYMENT_TARGET: "26.0"
  IPHONEOS_DEPLOYMENT_TARGET: "26.0"

jobs:
  release:
    runs-on: macos-26
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for release notes

      - name: Get version and check if release exists
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '\n')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

          # Check if tag already exists
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists, skipping release"
            echo "SKIP=true" >> $GITHUB_OUTPUT
          else
            echo "SKIP=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        if: steps.version.outputs.SKIP != 'true'
        id: notes
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          # Build release notes
          {
            echo "NOTES<<EOF"
            echo "## IrohSwift $VERSION"
            echo ""
            echo "### What's Changed"
            echo ""

            if [ -n "$PREV_TAG" ]; then
              # Categorize commits by conventional commit type
              echo "#### Features"
              git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --grep="^feat" | head -20 || true
              echo ""
              echo ""
              echo "#### Bug Fixes"
              git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --grep="^fix" | head -20 || true
              echo ""
              echo ""
              echo "#### Other Changes"
              git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --grep="^chore\|^ci\|^docs\|^refactor\|^style\|^test" | head -20 || true
              echo ""
              echo ""
              echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...$VERSION"
            else
              echo "Initial release"
              git log --pretty=format:"- %s" | head -20 || true
            fi
            echo ""
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create pre-release with tag
        if: steps.version.outputs.SKIP != 'true'
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          gh release create "$VERSION" \
            --title "IrohSwift $VERSION" \
            --notes "ðŸš§ Building release artifacts..." \
            --prerelease
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust
        if: steps.version.outputs.SKIP != 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,aarch64-apple-ios-sim,aarch64-apple-darwin

      - name: Cache Rust
        if: steps.version.outputs.SKIP != 'true'
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust

      - name: Install cbindgen
        if: steps.version.outputs.SKIP != 'true'
        run: cargo install cbindgen

      - name: Build XCFramework
        if: steps.version.outputs.SKIP != 'true'
        run: ./scripts/build-xcframework.sh

      - name: Run tests
        if: steps.version.outputs.SKIP != 'true'
        run: swift test
        env:
          IROH_LOCAL_DEV: "1"

      - name: Create release archive
        if: steps.version.outputs.SKIP != 'true'
        id: archive
        run: |
          zip -r IrohSwiftFFI.xcframework.zip IrohSwiftFFI.xcframework
          CHECKSUM=$(shasum -a 256 IrohSwiftFFI.xcframework.zip | cut -d ' ' -f 1)
          echo "CHECKSUM=$CHECKSUM" >> $GITHUB_OUTPUT

      - name: Upload artifact to pre-release
        if: steps.version.outputs.SKIP != 'true'
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          gh release upload "$VERSION" IrohSwiftFFI.xcframework.zip --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Smoke test - verify artifact download
        if: steps.version.outputs.SKIP != 'true'
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          CHECKSUM=${{ steps.archive.outputs.CHECKSUM }}

          # Download and verify the uploaded artifact
          mkdir -p smoke-test && cd smoke-test
          curl -L -o test.zip "https://github.com/${{ github.repository }}/releases/download/${VERSION}/IrohSwiftFFI.xcframework.zip"

          # Verify checksum
          DOWNLOADED_CHECKSUM=$(shasum -a 256 test.zip | cut -d ' ' -f 1)
          if [ "$CHECKSUM" != "$DOWNLOADED_CHECKSUM" ]; then
            echo "::error::Checksum mismatch! Expected $CHECKSUM, got $DOWNLOADED_CHECKSUM"
            exit 1
          fi
          echo "âœ“ Artifact checksum verified"

          # Verify zip contents
          unzip -t test.zip
          echo "âœ“ Artifact is a valid zip"

          # Verify XCFramework structure
          unzip -q test.zip
          if [ ! -f "IrohSwiftFFI.xcframework/Info.plist" ]; then
            echo "::error::Invalid XCFramework structure"
            exit 1
          fi
          echo "âœ“ XCFramework structure verified"

      - name: Promote to full release
        if: steps.version.outputs.SKIP != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NOTES: ${{ steps.notes.outputs.NOTES }}
          VERSION: ${{ steps.version.outputs.VERSION }}
          CHECKSUM: ${{ steps.archive.outputs.CHECKSUM }}
        run: |
          # Build release notes file
          {
            echo "$NOTES"
            echo ""
            echo "### Installation"
            echo ""
            echo 'Add to your `Package.swift`:'
            echo '```swift'
            echo ".package(url: \"https://github.com/${{ github.repository }}.git\", from: \"${VERSION}\")"
            echo '```'
            echo ""
            echo "### Checksum"
            echo '```'
            echo "${CHECKSUM}"
            echo '```'
          } > /tmp/release-notes.md

          # Update release with full notes and remove pre-release flag
          gh release edit "$VERSION" --prerelease=false --notes-file /tmp/release-notes.md

      - name: Update Package.swift with checksum
        if: steps.version.outputs.SKIP != 'true'
        run: |
          CHECKSUM=${{ steps.archive.outputs.CHECKSUM }}
          sed -i '' "s/CHECKSUM_PLACEHOLDER/$CHECKSUM/" Package.swift

          # Commit and push the checksum update
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Package.swift
          git commit -m "chore: update checksum for ${{ steps.version.outputs.VERSION }} [skip ci]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
