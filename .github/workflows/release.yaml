name: Release

on:
  push:
    branches: [main]
    paths:
      - 'VERSION'

env:
  MACOSX_DEPLOYMENT_TARGET: "26.0"
  IPHONEOS_DEPLOYMENT_TARGET: "26.0"

jobs:
  release:
    runs-on: macos-26
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version and check if release exists
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '\n')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

          # Check if tag already exists
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists, skipping release"
            echo "SKIP=true" >> $GITHUB_OUTPUT
          else
            echo "SKIP=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Rust
        if: steps.version.outputs.SKIP != 'true'
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,aarch64-apple-ios-sim,aarch64-apple-darwin

      - name: Cache Rust
        if: steps.version.outputs.SKIP != 'true'
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust

      - name: Install cbindgen
        if: steps.version.outputs.SKIP != 'true'
        run: cargo install cbindgen

      - name: Build XCFramework
        if: steps.version.outputs.SKIP != 'true'
        run: ./scripts/build-xcframework.sh

      - name: Run tests
        if: steps.version.outputs.SKIP != 'true'
        run: swift test
        env:
          IROH_LOCAL_DEV: "1"

      - name: Create release archive and get checksum
        if: steps.version.outputs.SKIP != 'true'
        id: archive
        run: |
          zip -r IrohSwiftFFI.xcframework.zip IrohSwiftFFI.xcframework
          CHECKSUM=$(shasum -a 256 IrohSwiftFFI.xcframework.zip | cut -d ' ' -f 1)
          echo "CHECKSUM=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "Checksum: $CHECKSUM"

      - name: Generate release notes
        if: steps.version.outputs.SKIP != 'true'
        id: notes
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          {
            echo "NOTES<<EOF"
            echo "## IrohSwift $VERSION"
            echo ""
            echo "### What's Changed"
            echo ""

            if [ -n "$PREV_TAG" ]; then
              git log ${PREV_TAG}..HEAD --pretty=format:"- %s" | head -20 || true
              echo ""
              echo ""
              echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...$VERSION"
            else
              echo "Initial release"
              git log --pretty=format:"- %s" | head -20 || true
            fi
            echo ""
            echo "EOF"
          } >> $GITHUB_OUTPUT

      # Step 1: Create release with artifact (tag created on current commit)
      - name: Create GitHub release with artifact
        if: steps.version.outputs.SKIP != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NOTES: ${{ steps.notes.outputs.NOTES }}
          VERSION: ${{ steps.version.outputs.VERSION }}
          CHECKSUM: ${{ steps.archive.outputs.CHECKSUM }}
        run: |
          {
            echo "$NOTES"
            echo ""
            echo "### Installation"
            echo ""
            echo 'Add to your `Package.swift`:'
            echo '```swift'
            echo ".package(url: \"https://github.com/${{ github.repository }}.git\", from: \"${VERSION}\")"
            echo '```'
            echo ""
            echo "### Checksum"
            echo '```'
            echo "${CHECKSUM}"
            echo '```'
          } > /tmp/release-notes.md

          gh release create "$VERSION" \
            IrohSwiftFFI.xcframework.zip \
            --title "IrohSwift $VERSION" \
            --notes-file /tmp/release-notes.md

      # Step 2: Commit checksum to Package.swift
      - name: Update Package.swift with checksum
        if: steps.version.outputs.SKIP != 'true'
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          CHECKSUM=${{ steps.archive.outputs.CHECKSUM }}

          # Update Package.swift with actual checksum
          sed -i '' 's/let checksum = ".*"/let checksum = "'"$CHECKSUM"'"/' Package.swift

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Package.swift
          git commit -m "chore: set checksum for $VERSION [skip ci]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 3: Move tag to the commit with correct checksum
      - name: Update tag to point to checksum commit
        if: steps.version.outputs.SKIP != 'true'
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          # Force-update tag to point to current commit (with checksum)
          # This preserves the release association
          git tag -f "$VERSION"
          git push origin "$VERSION" --force

          echo "Tag $VERSION now points to $(git rev-parse HEAD)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Smoke test - verify artifact download
        if: steps.version.outputs.SKIP != 'true'
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          CHECKSUM=${{ steps.archive.outputs.CHECKSUM }}

          mkdir -p smoke-test && cd smoke-test
          curl -L -o test.zip "https://github.com/${{ github.repository }}/releases/download/${VERSION}/IrohSwiftFFI.xcframework.zip"

          DOWNLOADED_CHECKSUM=$(shasum -a 256 test.zip | cut -d ' ' -f 1)
          if [ "$CHECKSUM" != "$DOWNLOADED_CHECKSUM" ]; then
            echo "::error::Checksum mismatch! Expected $CHECKSUM, got $DOWNLOADED_CHECKSUM"
            exit 1
          fi
          echo "âœ“ Artifact download and checksum verified"
